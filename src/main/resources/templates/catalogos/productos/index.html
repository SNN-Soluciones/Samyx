<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/layout :: head}"></head>
<body class="fix-header card-no-border logo-center">

<div id="main-wrapper">
  <header th:replace="~{layout/layout :: header}"></header>
  <aside th:replace="~{layout/layout :: aside}"></aside>

  <!-- Page wrapper -->
  <div class="page-wrapper">
    <!-- Bread crumb -->
    <div class="page-header">
      <div class="page-header-content">
        <div class="page-title">
          <h1>
            <i class="fas fa-box"></i>
            <span th:text="#{txt.productos}">Productos</span>
          </h1>
        </div>
        <div class="page-breadcrumb">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/home}">
                  <i class="fas fa-home"></i>
                  <span th:text="#{txt.inicio}">Inicio</span>
                </a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                <span th:text="#{txt.productos}">Productos</span>
              </li>
            </ol>
          </nav>
        </div>
      </div>
    </div>

    <!-- Container fluid -->
    <div class="container-fluid">
      <!-- Filtros y acciones -->
      <div class="action-bar">
        <div class="action-bar-left">
          <button type="button" class="btn-action btn-primary" th:onclick="'location.href=\'' + @{/productos/form} + '\''">
            <i class="fas fa-plus-circle"></i>
            <span>Nuevo Producto</span>
          </button>

          <button type="button" class="btn-action btn-secondary" id="btnImportarProductos">
            <i class="fas fa-file-import"></i>
            <span>Importar</span>
          </button>

          <button type="button" class="btn-action btn-info" id="btnExportarProductos">
            <i class="fas fa-file-export"></i>
            <span>Exportar</span>
          </button>
        </div>

        <div class="action-bar-right">
          <div class="search-box">
            <form method="get" th:action="@{/productos/}" autocomplete="off">
              <div class="search-input-group">
                <i class="fas fa-search"></i>
                <input type="search"
                       name="q"
                       class="search-input"
                       placeholder="Buscar por código, nombre o proveedor..."
                       th:value="${param.q}">
                <button type="submit" class="search-button">
                  <span>Buscar</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${totalProductos}">0</h3>
            <p class="stat-label">Total Productos</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${productosActivos}">0</h3>
            <p class="stat-label">Productos Activos</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${productosBajoStock}">0</h3>
            <p class="stat-label">Bajo Stock</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
            <i class="fas fa-truck"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${totalProveedores}">0</h3>
            <p class="stat-label">Proveedores</p>
          </div>
        </div>
      </div>

      <!-- Tabla de productos -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-list"></i>
            Lista de Productos
          </h2>
          <div class="card-actions">
            <button class="btn-icon" id="btnRefresh" title="Actualizar">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-icon" id="btnFilter" title="Filtros">
              <i class="fas fa-filter"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Mensaje cuando hay búsqueda -->
          <div class="search-results-info" th:if="${param.q}">
            <p>
              Resultados de búsqueda para: <strong th:text="${param.q}"></strong>
              <a th:href="@{/productos/}" class="clear-search">
                <i class="fas fa-times-circle"></i> Limpiar búsqueda
              </a>
            </p>
          </div>

          <!-- Tabla responsiva -->
          <div class="table-container">
            <table class="modern-table">
              <thead>
              <tr>
                <th class="th-codigo">Código</th>
                <th class="th-proveedor">Proveedor</th>
                <th class="th-nombre">Nombre del Producto</th>
                <th class="th-precio text-right">Precio</th>
                <th class="th-impuesto text-right">Impuestos</th>
                <th class="th-precio-total text-right">Precio Total</th>
                <th class="th-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'N'}">
                  Stock Actual
                </th>
                <th class="th-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S'}">
                  Stock Unidades
                </th>
                <th class="th-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S'}">
                  Stock Fracciones
                </th>
                <th class="th-acciones text-center">Acciones</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="producto : ${ListaProductos}"
                  th:classappend="${producto.estadoProducto == 'D'} ? 'row-inactive' : ''"
                  th:attr="data-id=${producto.id}">

                <td class="td-codigo">
                  <span class="codigo-badge" th:text="${producto.codigo}"></span>
                </td>

                <td class="td-proveedor">
                  <span th:text="${producto.proveedor != null ? producto.proveedor.nombreCompleto : 'No asignado'}"></span>
                </td>

                <td class="td-nombre">
                  <div class="producto-info">
                    <span class="producto-nombre" th:text="${producto.nombreProducto}"></span>
                    <span class="producto-estado"
                          th:if="${producto.estadoProducto == 'D'}"
                          th:classappend="'estado-inactivo'">
                                                <i class="fas fa-ban"></i> Desactivado
                                            </span>
                  </div>
                </td>

                <td class="td-precio text-right">
                  <span class="precio-valor" th:text="${producto.moneda.simboloMoneda}+' '+${#numbers.formatDecimal(producto.precio, 0, 'POINT', 2, 'COMMA')}"></span>
                </td>

                <td class="td-impuesto text-right">
                  <span class="impuesto-valor" th:text="${producto.moneda.simboloMoneda}+' '+${#numbers.formatDecimal(producto.impuestoTotal, 0, 'POINT', 2, 'COMMA')}"></span>
                </td>

                <td class="td-precio-total text-right">
                  <span class="precio-total-valor" th:text="${producto.moneda.simboloMoneda}+' '+${#numbers.formatDecimal(producto.precioFinal, 0, 'POINT', 2, 'COMMA')}"></span>
                </td>

                <td class="td-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'N'}">
                                        <span class="stock-badge"
                                              th:classappend="${producto.inventarioActual <= 10} ? 'stock-bajo' : 'stock-normal'"
                                              th:text="${#numbers.formatDecimal(producto.inventarioActual, 0, 'POINT', 2, 'COMMA')} +' '+ ${producto.unidadDeMedida.simbolo}">
                                        </span>
                </td>

                <td class="td-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S' && producto.tipoVenta == 'U'}">
                  <span class="stock-badge stock-normal" th:text="${#numbers.formatDecimal(producto.inventarioActual, 0, 'POINT', 2, 'COMMA')} +' '+ ${producto.unidadDeMedida.simbolo}"></span>
                </td>
                <td class="td-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S' && producto.tipoVenta == 'F'}">
                  <span class="stock-badge stock-normal" th:text="${#numbers.formatDecimal(producto.inventarioActual / producto.fraccionesPorUnidad, 0, 'POINT', 2, 'COMMA')} +' '+ ${producto.unidadDeMedida.simbolo}"></span>
                </td>

                <td class="td-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S' && producto.tipoVenta == 'F'}">
                  <span class="stock-badge stock-normal" th:text="${#numbers.formatDecimal(producto.inventarioActual, 0, 'POINT', 2, 'COMMA')} +' f'"></span>
                </td>
                <td class="td-inventario text-center" th:if="${session.SESSION_SISTEMA_FARMACIA == 'S' && producto.tipoVenta == 'U'}">
                  <span class="stock-badge">N/A</span>
                </td>

                <td class="td-acciones">
                  <div class="action-buttons">
                    <button class="btn-table-action btn-view"
                            th:onclick="'verDetalleProducto(' + ${producto.id} + ')'"
                            title="Ver detalles">
                      <i class="fas fa-eye"></i>
                    </button>

                    <a class="btn-table-action btn-edit"
                       th:href="@{/productos/edit/{id}(id=${producto.id})}"
                       title="Editar">
                      <i class="fas fa-edit"></i>
                    </a>

                    <button class="btn-table-action btn-delete"
                            th:onclick="'confirmarEliminarProducto(' + ${producto.id} + ')'"
                            title="Eliminar"
                            th:if="${producto.estadoProducto != 'D'}">
                      <i class="fas fa-trash"></i>
                    </button>

                    <button class="btn-table-action btn-activate"
                            th:onclick="'activarProducto(' + ${producto.id} + ')'"
                            title="Activar"
                            th:if="${producto.estadoProducto == 'D'}">
                      <i class="fas fa-check-circle"></i>
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>

            <!-- Estado vacío -->
            <div class="empty-state" th:if="${#lists.isEmpty(ListaProductos)}">
              <div class="empty-icon">
                <i class="fas fa-box-open"></i>
              </div>
              <h3>No hay productos registrados</h3>
              <p th:if="${param.q}">No se encontraron productos que coincidan con tu búsqueda</p>
              <p th:unless="${param.q}">Comienza agregando tu primer producto</p>
              <button class="btn-primary" th:onclick="'location.href=\'' + @{/productos/form} + '\''">
                <i class="fas fa-plus-circle"></i>
                Agregar Producto
              </button>
            </div>
          </div>

          <!-- Paginación -->
          <nav th:replace="~{layout/paginator-nav :: paginator}"></nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer th:replace="~{layout/layout :: footer}"></footer>
</div>

<!-- Modal detalle producto -->
<div class="modal fade" id="modalDetalleProducto" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Producto</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="detalleProductoContent">
        <!-- Contenido cargado dinámicamente -->
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<div th:replace="~{layout/layout :: scripts}"></div>

<!-- CSS específico -->
<link th:href="@{/css/pages/catalogos/productos.css}" rel="stylesheet" />

<!-- JavaScript específico -->
<script th:src="@{/js/pages/catalogos/productos.js}"></script>
</body>
</html>