<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/layout :: head}"></head>
<body class="fix-header card-no-border logo-center">

<div id="main-wrapper">
  <header th:replace="~{layout/layout :: header}"></header>
  <aside th:replace="~{layout/layout :: aside}"></aside>

  <!-- Page wrapper -->
  <div class="page-wrapper">
    <!-- Bread crumb -->
    <div class="page-header">
      <div class="page-header-content">
        <div class="page-title">
          <h1>
            <i class="fas fa-inbox"></i>
            <span>Mensajes Receptor Automático</span>
          </h1>
        </div>
        <div class="page-breadcrumb">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/home}">
                  <i class="fas fa-home"></i>
                  <span th:text="#{txt.inicio}">Inicio</span>
                </a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                <span>MR Automático</span>
              </li>
            </ol>
          </nav>
        </div>
      </div>
    </div>

    <!-- Container fluid -->
    <div class="container-fluid">
      <!-- Filtros y acciones -->
      <div class="action-bar">
        <div class="action-bar-left">
          <!-- Filtro de estado -->
          <div class="filter-group">
            <label>Estado:</label>
            <select class="filter-select" id="filtroEstado" onchange="filtrarPorEstado()">
              <option value="P" th:selected="${param.e == 'P'}">Pendientes</option>
              <option value="A" th:selected="${param.e == 'A'}">Aplicados</option>
              <option value="T" th:selected="${param.e == null || param.e == 'T'}">Todos</option>
            </select>
          </div>

          <button type="button" class="btn-action btn-info" id="btnRefreshMR">
            <i class="fas fa-sync-alt"></i>
            <span>Actualizar</span>
          </button>
        </div>

        <div class="action-bar-right">
          <div class="search-box">
            <form method="get" th:action="@{/mensaje-receptor-inbox/}" autocomplete="off">
              <input type="hidden" name="e" th:value="${param.e ?: 'P'}" />
              <div class="search-input-group">
                <i class="fas fa-search"></i>
                <input type="search"
                       name="q"
                       class="search-input"
                       placeholder="Buscar por clave, emisor o identificación..."
                       th:value="${param.q}">
                <button type="submit" class="search-button">
                  <span>Buscar</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${totalDocumentos ?: '0'}">0</h3>
            <p class="stat-label">Total Documentos</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${documentosPendientes ?: '0'}">0</h3>
            <p class="stat-label">Pendientes</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${documentosAplicados ?: '0'}">0</h3>
            <p class="stat-label">Aplicados</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <div class="stat-content">
            <h3 class="stat-value" th:text="${montoTotal ?: '₡0'}">₡0</h3>
            <p class="stat-label">Monto Total</p>
          </div>
        </div>
      </div>

      <!-- Tabla de documentos -->
      <div class="content-card">
        <div class="card-header">
          <h2 class="card-title">
            <i class="fas fa-list"></i>
            Documentos Recibidos
          </h2>
          <div class="card-actions">
            <span class="badge badge-info" th:if="${param.e == 'P'}">Mostrando: Pendientes</span>
            <span class="badge badge-success" th:if="${param.e == 'A'}">Mostrando: Aplicados</span>
            <span class="badge badge-secondary" th:if="${param.e == null || param.e == 'T'}">Mostrando: Todos</span>
          </div>
        </div>

        <div class="card-body">
          <!-- Mensaje cuando hay búsqueda -->
          <div class="search-results-info" th:if="${param.q}">
            <p>
              Resultados de búsqueda para: <strong th:text="${param.q}"></strong>
              <a th:href="@{/mensaje-receptor-inbox/(e=${param.e})}" class="clear-search">
                <i class="fas fa-times-circle"></i> Limpiar búsqueda
              </a>
            </p>
          </div>

          <!-- Tabla responsiva -->
          <div class="table-container">
            <table class="modern-table">
              <thead>
              <tr>
                <th class="th-emisor">Emisor</th>
                <th class="th-identificacion">Identificación</th>
                <th class="th-clave">Clave</th>
                <th class="th-fecha">Fecha Emisión</th>
                <th class="th-impuestos text-right">Impuestos</th>
                <th class="th-total text-right">Total</th>
                <th class="th-documentos text-center">Documentos</th>
                <th class="th-estado text-center">Estado</th>
                <th class="th-acciones text-center">Acciones</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="k : ${listaDocumentos}"
                  th:attr="data-id=${k.id}"
                  th:classappend="${k.estado == 'A'} ? 'row-applied' : ''">

                <td class="td-emisor">
                  <div class="emisor-info">
                    <span class="emisor-nombre" th:text="${k.emisorFactura}"></span>
                  </div>
                </td>

                <td class="td-identificacion">
                  <span class="identificacion-badge" th:text="${k.emisorIdentificacion}"></span>
                </td>

                <td class="td-clave">
                                        <span class="clave-text"
                                              th:title="${k.clave}" data-toggle="tooltip">
                                        </span>
                </td>

                <td class="td-fecha">
                                        <span th:if="${k.fechaEmision != null && !#strings.isEmpty(k.fechaEmision)}">
                                            <span th:if="${#strings.contains(k.fechaEmision, 'T')}"
                                                  class="fecha-text">
                                                <i class="far fa-calendar"></i>
                                                <span th:text="${#strings.substring(k.fechaEmision, 0, 10)}"></span>
                                            </span>
                                            <span th:unless="${#strings.contains(k.fechaEmision, 'T')}"
                                                  class="fecha-text" th:text="${k.fechaEmision}">
                                            </span>
                                        </span>
                </td>

                <td class="td-impuestos text-right">
                                        <span class="monto-text"
                                              th:text="${k.moneda}+' '+${#numbers.formatDecimal(k.totalImpuestos, 0, 'POINT', 2, 'COMMA')}">
                                        </span>
                </td>

                <td class="td-total text-right">
                                        <span class="monto-total"
                                              th:text="${k.moneda}+' '+${#numbers.formatDecimal(k.totalComprobante, 0, 'POINT', 2, 'COMMA')}">
                                        </span>
                </td>

                <td class="td-documentos text-center">
                  <div class="document-links">
                    <a th:href="@{'/mr-inbox/' + ${k.facturaXml}}"
                       target="_blank"
                       class="doc-link doc-xml"
                       title="Ver XML">
                      <i class="fas fa-file-code"></i>
                      <span>XML</span>
                    </a>
                    <a th:href="@{'/mr-inbox/' + ${k.facturaPdf}}"
                       target="_blank"
                       class="doc-link doc-pdf"
                       title="Ver PDF">
                      <i class="fas fa-file-pdf"></i>
                      <span>PDF</span>
                    </a>
                  </div>
                </td>

                <td class="td-estado text-center">
                                        <span class="estado-badge"
                                              th:classappend="${k.estado == 'P'} ? 'estado-pendiente' : 'estado-aplicado'">
                                            <span th:text="${k.estado == 'P' ? 'Pendiente' : 'Aplicado'}"></span>
                                        </span>
                </td>

                <td class="td-acciones">
                  <div class="action-buttons">
                    <a class="btn-table-action btn-process"
                       th:href="@{/mensaje-receptor-inbox/form/{id}(id=${k.id})}"
                       title="Procesar documento"
                       th:if="${k.estado == 'P'}">
                      <i class="fas fa-cogs"></i>
                    </a>

                    <button class="btn-table-action btn-view"
                            th:onclick="'verDetalleMR(' + ${k.id} + ')'"
                            title="Ver detalles">
                      <i class="fas fa-eye"></i>
                    </button>

                    <button class="btn-table-action btn-history"
                            th:onclick="'verHistorialMR(' + ${k.id} + ')'"
                            title="Ver historial"
                            th:if="${k.estado == 'A'}">
                      <i class="fas fa-history"></i>
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>

            <!-- Estado vacío -->
            <div class="empty-state" th:if="${#lists.isEmpty(listaDocumentos)}">
              <div class="empty-icon">
                <i class="fas fa-inbox"></i>
              </div>
              <h3>No hay documentos en el inbox</h3>
              <p th:if="${param.q}">No se encontraron documentos que coincidan con tu búsqueda</p>
              <p th:unless="${param.q}">Los documentos recibidos aparecerán aquí</p>
              <button class="btn-primary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i>
                Actualizar
              </button>
            </div>
          </div>

          <!-- Paginación -->
          <nav th:replace="~{layout/paginator-nav :: paginator}"></nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer th:replace="~{layout/layout :: footer}"></footer>
</div>

<!-- Modal detalle MR -->
<div class="modal fade" id="modalDetalleMR" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalle del Mensaje Receptor</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="detalleMRContent">
        <!-- Contenido cargado dinámicamente -->
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<div th:replace="~{layout/layout :: scripts}"></div>

<!-- CSS específico -->
<link th:href="@{/css/pages/mensaje-receptor/mr-inbox.css}" rel="stylesheet" />

<!-- JavaScript específico -->
<script th:src="@{/js/pages/mensaje-receptor/mr-inbox.js}"></script>
</body>
</html>