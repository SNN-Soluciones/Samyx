<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/layout :: head}">
  <title>Lista de Empresas - SAMYX</title>
</head>
<body>
<div id="main-wrapper">
  <!-- Header -->
  <header th:replace="~{layout/layout :: header}"></header>

  <!-- Fragmento aside vacío para compatibilidad -->
  <aside th:fragment="sidebar" style="display: none;"></aside>

  <!-- Page wrapper -->
  <div class="page-wrapper">
    <!-- Page Header -->
    <div class="page-header-advanced">
      <div class="page-header-content">
        <div class="page-header-left">
          <h1 class="page-title">
            <i class="fas fa-building"></i>
            Gestión de Empresas
          </h1>
          <p class="page-subtitle">Administra todas las empresas del sistema</p>

          <!-- Estadísticas rápidas -->
          <div class="quick-stats" id="quickStats">
            <!-- Se llena dinámicamente con JS -->
          </div>
        </div>

        <div class="page-header-right">
          <!-- Búsqueda -->
          <form class="search-form" method="get" autocomplete="off" th:action="@{/emisor/}">
            <div class="search-group">
              <i class="fas fa-search"></i>
              <input type="search"
                     name="q"
                     class="search-input"
                     th:value="${param.q}"
                     placeholder="Buscar por nombre o identificación..."
                     autocomplete="off">
              <button type="submit" class="search-btn">
                Buscar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Criterio de búsqueda activo -->
      <div class="search-criteria" th:if="${param.q != null and #strings.length(param.q) > 0}">
        <i class="fas fa-filter"></i>
        <span>Filtrado por: <strong th:text="${param.q}"></strong></span>
        <a class="clear-search" th:href="@{/emisor/}">
          <i class="fas fa-times"></i> Limpiar búsqueda
        </a>
      </div>
    </div>

    <!-- Container -->
    <div class="container-fluid">
      <!-- Vista de tabla/grid switch -->
      <div class="view-controls">
        <div class="view-buttons">
          <button class="view-btn active" data-view="table" title="Vista de tabla">
            <i class="fas fa-list"></i>
          </button>
          <button class="view-btn" data-view="grid" title="Vista de cuadrícula">
            <i class="fas fa-th-large"></i>
          </button>
        </div>

        <div class="results-info">
          <span th:text="${#lists.size(listaEmisor)} + ' empresas encontradas'"></span>
        </div>
      </div>

      <!-- Vista de Tabla -->
      <div class="table-container view-table active">
        <table class="custom-table">
          <thead>
          <tr>
            <th class="sortable" data-sort="name">
              <span>Empresa</span>
              <i class="fas fa-sort"></i>
            </th>
            <th class="sortable" data-sort="id">
              <span>Identificación</span>
              <i class="fas fa-sort"></i>
            </th>
            <th>
              <span>Correo</span>
            </th>
            <th>
              <span>Teléfono</span>
            </th>
            <th class="sortable" data-sort="cert">
              <span>Vencimiento Certificado</span>
              <i class="fas fa-sort"></i>
            </th>
            <th>
              <span>Estado</span>
            </th>
            <th class="text-center">
              <span>Acciones</span>
            </th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="k, iter : ${listaEmisor}"
              th:classappend="${!k.emisor.statusEmpresa} ? 'row-inactive' : ''"
              th:attr="data-empresa-id=${k.emisor.id}">

            <td class="empresa-nombre">
              <div class="empresa-info">
                <div class="empresa-avatar">
                  <i class="fas fa-building"></i>
                </div>
                <div>
                  <strong th:text="${k.emisor.nombreRazonSocial}"></strong>
                  <small class="text-muted" th:if="${!k.emisor.statusEmpresa}">Inactiva</small>
                </div>
              </div>
            </td>

            <td>
              <span class="identificacion-badge" th:text="${k.emisor.identificacion}"></span>
            </td>

            <td>
              <a class="email-link" th:href="'mailto:' + ${k.emisor.email}"
                 th:text="${k.emisor.email}"></a>
            </td>

            <td>
              <span class="phone-number" th:text="${k.emisor.telefono}"></span>
            </td>

            <td>
              <div class="fecha-caducidad-wrapper"
                   th:if="${k.emisor.fechaCaducidadCert != null}">
                                        <span class="fecha-caducidad"
                                              th:attr="data-fecha=${k.emisor.fechaCaducidadCert}"
                                              th:text="${#dates.format(k.emisor.fechaCaducidadCert, 'dd/MM/yyyy')}">
                                        </span>
                <span class="dias-restantes"></span>
              </div>
              <span class="text-muted" th:unless="${k.emisor.fechaCaducidadCert != null}">
                                        No definida
                                    </span>
            </td>

            <td>
                                    <span class="status-badge"
                                          th:classappend="${k.emisor.statusEmpresa} ? 'status-active' : 'status-inactive'">
                                        <i class="fas fa-circle"></i>
                                        <span th:text="${k.emisor.statusEmpresa} ? 'Activa' : 'Inactiva'"></span>
                                    </span>
            </td>

            <td class="text-center">
              <div class="action-buttons">
                <a class="btn-table-action btn-primary"
                   th:href="@{/emisor/ingresar/}+${k.emisor.id}"
                   data-tooltip="Ingresar a la empresa">
                  <i class="fas fa-sign-in-alt"></i>
                </a>

                <a class="btn-table-action btn-warning"
                   sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_USER')"
                   th:href="@{/emisor/edit/}+${k.emisor.id}"
                   data-tooltip="Modificar empresa">
                  <i class="fas fa-edit"></i>
                </a>

                <button class="btn-table-action btn-info btn-more-actions"
                        data-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>

                <div class="dropdown-menu dropdown-menu-right">
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-chart-line"></i> Ver estadísticas
                  </a>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-file-alt"></i> Ver documentos
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item text-danger" href="#">
                    <i class="fas fa-ban"></i> Desactivar empresa
                  </a>
                </div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>

        <!-- Empty state para tabla -->
        <div class="empty-state-table" th:if="${#lists.isEmpty(listaEmisor)}">
          <i class="fas fa-inbox"></i>
          <h4>No se encontraron empresas</h4>
          <p>No hay empresas que coincidan con los criterios de búsqueda</p>
        </div>
      </div>

      <!-- Vista de Grid -->
      <div class="grid-container view-grid">
        <div class="empresa-grid">
          <div class="empresa-card"
               th:each="k : ${listaEmisor}"
               th:classappend="${!k.emisor.statusEmpresa} ? 'card-inactive' : ''">

            <div class="card-header">
              <div class="card-avatar">
                <i class="fas fa-building"></i>
              </div>
              <span class="card-status"
                    th:classappend="${k.emisor.statusEmpresa} ? 'status-active' : 'status-inactive'">
                                    <i class="fas fa-circle"></i>
                                </span>
            </div>

            <div class="card-body">
              <h3 class="card-title" th:text="${k.emisor.nombreRazonSocial}"></h3>

              <div class="card-info">
                <div class="info-row">
                  <i class="fas fa-id-card"></i>
                  <span th:text="${k.emisor.identificacion}"></span>
                </div>
                <div class="info-row">
                  <i class="fas fa-envelope"></i>
                  <span th:text="${k.emisor.email}"></span>
                </div>
                <div class="info-row" th:if="${k.emisor.telefono}">
                  <i class="fas fa-phone"></i>
                  <span th:text="${k.emisor.telefono}"></span>
                </div>
                <div class="info-row cert-info"
                     th:if="${k.emisor.fechaCaducidadCert != null}">
                  <i class="fas fa-key"></i>
                  <span class="fecha-caducidad"
                        th:attr="data-fecha=${k.emisor.fechaCaducidadCert}"
                        th:text="${#dates.format(k.emisor.fechaCaducidadCert, 'dd/MM/yyyy')}">
                                        </span>
                </div>
              </div>
            </div>

            <div class="card-footer">
              <a class="btn-card btn-primary"
                 th:href="@{/emisor/ingresar/}+${k.emisor.id}">
                <i class="fas fa-sign-in-alt"></i> Ingresar
              </a>
              <a class="btn-card btn-secondary"
                 sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_USER')"
                 th:href="@{/emisor/edit/}+${k.emisor.id}">
                <i class="fas fa-edit"></i> Modificar
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Paginación -->
      <nav th:replace="~{paginator-nav :: paginator}"></nav>

      <!-- Botón flotante para móviles -->
      <a sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_USER')"
         class="fab-button"
         th:href="@{/emisor/registrar-empresa/}">
        <i class="fas fa-plus"></i>
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer th:replace="~{layout/layout :: footer}"></footer>
</div>

<!-- Scripts -->
<div th:replace="~{layout/layout :: scripts}"></div>

<!-- CSS específico de esta página -->
<link th:href="@{/css/pages/emisor-list.css}" rel="stylesheet" />

<!-- JavaScript específico de esta página -->
<script th:src="@{/js/pages/emisor-list.js}"></script>
</body>
</html>