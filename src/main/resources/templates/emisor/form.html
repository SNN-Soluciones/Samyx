<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">
<head th:replace="~{layout/layout :: head}">
   <title>Editar Empresa - SAMYX</title>
</head>
<body>
<div id="main-wrapper">
   <!-- Header -->
   <header th:replace="~{layout/layout :: header}"></header>

   <!-- Page Content -->
   <main class="py-5">
      <div class="container-fluid">

         <!-- Page Header -->
         <div class="row mb-5">
            <div class="col-md-8">
               <h1 class="h2 mb-1">
                  <i class="fas fa-edit me-2"></i><span th:text="#{txt.editar.mis.datos}">Editar Datos de Empresa</span>
               </h1>
               <p class="text-muted mb-0">Administra la información de tu empresa</p>
            </div>
            <div class="col-md-4 text-md-end">
               <a class="btn btn-outline-secondary btn-lg" th:href="@{/emisor/}">
                  <i class="fas fa-arrow-left me-2"></i><span th:text="#{txt.btn-regresar}">Volver</span>
               </a>
            </div>
         </div>

         <!-- Alert Messages -->
         <div th:if="${param.exito}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            La empresa se registró con éxito, complete la información faltante, usuario contraseña y pin de Hacienda, además subir la llave criptográfica, crear la sucursal y la terminal y por ultimo dar acceso a su usuario para que pueda facturar.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
         </div>

         <div th:if="${cambiarLlave == 'S'} OR ${param.cambiarLlave}" class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            La llave criptográfica ha caducado, debe ingresar al <a href="https://www.hacienda.go.cr/ATV/Login.aspx" target="_blank" class="alert-link">sitio web del Ministerio de Hacienda</a>, regenerarla y actualizarla en la parte inferior de este formulario para continuar facturando.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
         </div>

         <!-- Tabs Card -->
         <div class="card border-0 shadow-sm">
            <!-- Nav tabs -->
            <div class="card-header bg-white border-0">
               <ul class="nav nav-tabs card-header-tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                     <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#datos-emisor" type="button" role="tab">
                        <i class="fas fa-building me-2"></i>Datos del Emisor
                     </button>
                  </li>
                  <li class="nav-item" role="presentation" th:if="${emisor.id != null}">
                     <button class="nav-link" id="getActividades" data-bs-toggle="tab" data-bs-target="#actividades-economicas" type="button" role="tab">
                        <i class="fas fa-briefcase me-2"></i>Actividades Económicas
                     </button>
                  </li>
                  <li class="nav-item" role="presentation" th:if="${emisor.id != null}">
                     <button class="nav-link" id="getSucursales" data-bs-toggle="tab" data-bs-target="#sucursales" type="button" role="tab">
                        <i class="fas fa-store me-2"></i>Sucursales
                     </button>
                  </li>
                  <li class="nav-item" role="presentation" th:if="${emisor.id != null}">
                     <button class="nav-link" id="getTerminales" data-bs-toggle="tab" data-bs-target="#terminales" type="button" role="tab">
                        <i class="fas fa-desktop me-2"></i>Terminales
                     </button>
                  </li>
                  <li class="nav-item" role="presentation" th:if="${emisor.id != null}">
                     <button class="nav-link" id="getUsuarios" data-bs-toggle="tab" data-bs-target="#acceso-usuarios" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Acceso a Usuarios
                     </button>
                  </li>
                  <li class="nav-item" role="presentation" th:if="${emisor.id != null}">
                     <button class="nav-link" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                        <i class="fas fa-code me-2"></i>API
                     </button>
                  </li>
               </ul>
            </div>

            <!-- Tab Content -->
            <div class="card-body">
               <div class="tab-content">

                  <!-- TAB: Datos del Emisor -->
                  <div class="tab-pane fade show active" id="datos-emisor" role="tabpanel">
                     <form id="formEmpresa" enctype="multipart/form-data" autocomplete="off" th:action="@{/emisor/save}" th:object="${emisor}" method="post">

                        <!-- Sección: Datos de la Empresa -->
                        <div class="row mb-4">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-building"></i><span th:text="#{txt.datos.de.la.empresa}">Datos de la Empresa</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="row">
                                       <div class="col-md-2 mb-3">
                                          <label for="codigoActividad" class="form-label"><span class="text-danger">*</span> Código Actividad</label>
                                          <input type="text" maxlength="6" class="form-control" id="codigoActividad" th:field="*{codigoActividad}" required>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="tipoDeIdentificacion" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.tipo.identificacion}">Tipo Identificación</span></label>
                                          <select class="form-select" id="tipoDeIdentificacion" th:field="*{tipoDeIdentificacion}" required>
                                             <option th:value="''" th:text="#{txt.combo.seleccione}">Seleccione</option>
                                             <option th:value="'1'" th:text="#{txt.cedula.fisica}">Cédula Física</option>
                                             <option th:value="'2'" th:text="#{txt.cedula.juridica}">Cédula Jurídica</option>
                                             <option th:value="'3'" th:text="#{txt.dimex}">DIMEX</option>
                                             <option th:value="'4'" th:text="#{txt.nite}">NITE</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="identificacion" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.identificacion}">Identificación</span></label>
                                          <input th:if="${emisor.tipoDeIdentificacion == null}" type="text" th:attr="maxlength=9" class="form-control num-integer" id="identificacion" th:field="*{identificacion}" required>
                                          <input th:if="${emisor.tipoDeIdentificacion != null && emisor.tipoDeIdentificacion.id == 1}" type="text" th:attr="maxlength=9" class="form-control num-integer" id="identificacion" th:field="*{identificacion}" required>
                                          <input th:if="${emisor.tipoDeIdentificacion != null && emisor.tipoDeIdentificacion.id == 2}" type="text" th:attr="maxlength=10" class="form-control num-integer" id="identificacion" th:field="*{identificacion}" required>
                                          <input th:if="${emisor.tipoDeIdentificacion != null && emisor.tipoDeIdentificacion.id == 3}" type="text" th:attr="maxlength=12" class="form-control num-integer" id="identificacion" th:field="*{identificacion}" required>
                                          <input th:if="${emisor.tipoDeIdentificacion != null && emisor.tipoDeIdentificacion.id == 4}" type="text" th:attr="maxlength=10" class="form-control num-integer" id="identificacion" th:field="*{identificacion}" required>
                                       </div>

                                       <div class="col-md-4 mb-3">
                                          <label for="nombreRazonSocial" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.nombre.razon.social}">Nombre / Razón Social</span></label>
                                          <input type="text" maxlength="100" class="form-control" id="nombreRazonSocial" th:field="*{nombreRazonSocial}" required>
                                       </div>

                                       <div class="col-md-4 mb-3">
                                          <label for="nombreComercial" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.nombre.comercial}">Nombre Comercial</span></label>
                                          <input type="text" maxlength="80" class="form-control" id="nombreComercial" th:field="*{nombreComercial}" required>
                                       </div>

                                       <div class="col-md-4 mb-3">
                                          <label for="email" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.email}">Email</span></label>
                                          <input type="email" class="form-control" id="email" th:field="*{email}" required>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="codigoPais" class="form-label"><span th:text="#{txt.codigo.pais}">Código País</span></label>
                                          <input type="text" class="form-control num-integer" maxlength="3" id="codigoPais" name="codigoPais" value="506" readonly>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="telefono" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.telefono}">Teléfono</span></label>
                                          <input type="text" class="form-control num-integer" maxlength="8" id="telefono" th:field="*{telefono}" required>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="fax" class="form-label"><span th:text="#{txt.fax}">Fax</span></label>
                                          <input type="text" class="form-control num-integer" maxlength="8" id="fax" th:field="*{fax}">
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Sección: Ubicación -->
                        <div class="row mb-4">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-map-marker-alt"></i><span th:text="#{txt.ubicacion.de.la.empresa}">Ubicación de la Empresa</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="row">
                                       <div class="col-md-3 mb-3">
                                          <label for="provincia" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.provincia}">Provincia</span></label>
                                          <select class="form-select" id="provincia" th:field="*{provincia}" required>
                                             <option value="" selected th:text="#{txt.combo.seleccione}">Seleccione</option>
                                             <option th:each="k : ${listaProvincias}" th:value="${k.id}" th:text="${k.provincia}"></option>
                                          </select>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="canton" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.canton}">Cantón</span></label>
                                          <select class="form-select" id="canton" th:field="*{canton}" required>
                                             <option th:each="k : ${listaCantones}" th:value="${k.id}" th:text="${k.canton}"></option>
                                          </select>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="distrito" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.distrito}">Distrito</span></label>
                                          <select class="form-select" id="distrito" th:field="*{distrito}" required>
                                             <option th:each="k : ${listaDistritos}" th:value="${k.id}" th:text="${k.distrito}"></option>
                                          </select>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="barrio" class="form-label"><span th:text="#{txt.barrio}">Barrio</span> (opcional)</label>
                                          <select class="form-select" id="barrio" th:field="*{barrio}">
                                             <option value="">Opcional</option>
                                             <option th:each="k : ${listaBarrios}" th:value="${k.id}" th:text="${k.barrio}"></option>
                                          </select>
                                       </div>

                                       <div class="col-md-12 mb-3">
                                          <label for="otrasSenas" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.otras.senas}">Otras Señas</span></label>
                                          <input type="text" class="form-control" id="otrasSenas" th:field="*{otrasSenas}" required>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Sección: Parámetros -->
                        <div class="row mb-4">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-cogs"></i><span th:text="#{txt.parametros.de.la.empresa}">Parámetros de la Empresa</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="row">
                                       <div class="col-md-12 mb-3">
                                          <label for="detalleEnFactura1" class="form-label"><span th:text="#{txt.detalle.factura1}">Detalle en Factura 1</span></label>
                                          <textarea rows="2" class="form-control" id="detalleEnFactura1" th:field="*{detalleEnFactura1}"></textarea>
                                       </div>

                                       <div class="col-md-12 mb-3">
                                          <label for="detalleEnFactura2" class="form-label"><span th:text="#{txt.detalle.factura2}">Detalle en Factura 2</span></label>
                                          <textarea rows="2" class="form-control" id="detalleEnFactura2" th:field="*{detalleEnFactura2}"></textarea>
                                       </div>

                                       <div class="col-md-12 mb-3">
                                          <label for="notaValidezProforma" class="form-label">Validez de la Proforma</label>
                                          <textarea rows="2" class="form-control" id="notaValidezProforma" th:field="*{notaValidezProforma}"></textarea>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="ambiente" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.ambiente.trabajo}">Ambiente Trabajo</span></label>
                                          <select class="form-select" id="ambiente" th:field="*{ambiente}" required>
                                             <option th:value="'prod'" th:text="#{txt.ambiente.prod}">Producción</option>
                                             <option sec:authorize="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN')" th:value="'stag'" th:text="#{txt.ambiente.stag}">Staging</option>
                                          </select>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="statusEmpresa" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.status.empresa}">Estado Empresa</span></label>
                                          <select class="form-select" id="statusEmpresa" th:field="*{statusEmpresa}" required>
                                             <option th:value="'1'" th:text="#{txt.estado.activo}">Activo</option>
                                             <option th:value="'0'" th:text="#{txt.estado.desactivado}">Desactivado</option>
                                          </select>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="emailNotificacion" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.email.notificaciones}">Email Notificaciones</span></label>
                                          <input type="email" class="form-control" id="emailNotificacion" th:field="*{emailNotificacion}" required>
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="impresion" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.impresion}">Impresión</span></label>
                                          <select class="form-select" id="impresion" th:field="*{impresion}" required>
                                             <option th:value="'1'" th:text="#{txt.carta}">Carta</option>
                                             <option th:value="'2'" th:text="#{txt.tiquete}">Tiquete</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="decimales" class="form-label"><span class="text-danger">*</span> Decimales</label>
                                          <input type="text" maxlength="1" class="form-control" id="decimales" th:field="*{decimales}" required>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="controlCajas" class="form-label"><span class="text-danger">*</span> Control Cajas</label>
                                          <select class="form-select" id="controlCajas" th:field="*{controlCajas}" required>
                                             <option th:value="'N'">No</option>
                                             <option th:value="'S'">Si</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="multiMonedaFactura" class="form-label"><span class="text-danger">*</span> Multi-moneda Factura</label>
                                          <select class="form-select" id="multiMonedaFactura" th:field="*{multiMonedaFactura}" required>
                                             <option th:value="'N'">No</option>
                                             <option th:value="'S'">Si</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="devolucionIva" class="form-label"><span class="text-danger">*</span> Devolución IVA</label>
                                          <select class="form-select" id="devolucionIva" th:field="*{devolucionIva}" required>
                                             <option th:value="'N'">No</option>
                                             <option th:value="'S'">Si</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="sistemaFarmacias" class="form-label"><span class="text-danger">*</span> Sistema Farmacias</label>
                                          <select class="form-select" id="sistemaFarmacias" th:field="*{sistemaFarmacias}" required>
                                             <option th:value="'N'">No</option>
                                             <option th:value="'S'">Si</option>
                                          </select>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="tipoCliente" class="form-label"><span class="text-danger">*</span> Tipo de Ventas</label>
                                          <select class="form-select" id="tipoCliente" th:field="*{tipoCliente}" required>
                                             <option th:value="'A'">Cantidad</option>
                                             <option th:value="'B'">Por unidad y fracción</option>
                                          </select>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Sección: Usuario y Contraseña Hacienda -->
                        <div class="row mb-4">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-key"></i><span th:text="#{txt.usuario.pw.mh}">Usuario y Contraseña Hacienda</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="alert alert-warning" th:if="${emisor.id != null}">
                                       <i class="fas fa-exclamation-triangle me-2"></i>
                                       <span th:text="#{txt.warning.datos.hacienda}">Advertencia sobre datos de Hacienda</span>
                                    </div>

                                    <div class="row">
                                       <div class="col-md-6 mb-3">
                                          <label for="userApi" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.user.api.prod}">Usuario API</span></label>
                                          <input type="text" class="form-control" id="userApi" th:field="*{userApi}" required>
                                       </div>

                                       <div class="col-md-4 mb-3">
                                          <label for="pwApi" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.pw.api.prod}">Contraseña API</span></label>
                                          <input type="text" class="form-control" id="pwApi" th:field="*{pwApi}" required>
                                       </div>

                                       <div class="col-md-2 mb-3">
                                          <label for="pingApi" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.ping.api.prod}">PIN API</span></label>
                                          <input type="text" class="form-control" maxlength="4" id="pingApi" th:field="*{pingApi}" required>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Sección: Llave Criptográfica -->
                        <div class="row mb-4" th:if="${emisor.id != null}">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-shield-alt"></i><span th:text="#{txt.llave.criptografica}">Llave Criptográfica</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="alert alert-warning">
                                       <i class="fas fa-exclamation-triangle me-2"></i>
                                       <span th:text="#{txt.warning.llave.criptografica}">Advertencia sobre llave criptográfica</span>
                                    </div>

                                    <div class="row">
                                       <div class="col-12 mb-3">
                                          <label for="llaveCriptografica" class="form-label"><span class="text-danger">*</span> <span th:text="#{txt.subir.llave.criptografica}">Subir Llave Criptográfica</span></label>
                                          <input type="file" id="llaveCriptografica" name="llaveCriptografica" class="form-control">
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="fechaEmisionCert" class="form-label">Fecha de Emisión</label>
                                          <input type="text" readonly class="form-control" id="fechaEmisionCert" th:field="*{fechaEmisionCert}">
                                       </div>

                                       <div class="col-md-3 mb-3">
                                          <label for="fechaCaducidadCert" class="form-label">Fecha de Caducidad</label>
                                          <input type="text" readonly class="form-control" id="fechaCaducidadCert" th:field="*{fechaCaducidadCert}">
                                       </div>

                                       <div class="col-12" id="loadLlaveCriptografica">
                                          <a th:if="${emisor.certificado != null and #strings.length(emisor.certificado)>0}"
                                             th:href="@{'/llave/'} + ${emisor.identificacion} + '/' + ${emisor.certificado}"
                                             class="btn btn-outline-primary btn-sm">
                                             <i class="fas fa-cloud-download-alt me-2"></i>Descargar Llave Criptográfica
                                          </a>
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Sección: Logo Empresa -->
                        <div class="row mb-4" th:if="${emisor.id != null}">
                           <div class="col-12">
                              <div class="card border-0 shadow-sm">
                                 <div class="card-header bg-light border-0 pb-0">
                                    <h6 class="mb-0 form-section-title">
                                       <i class="fas fa-image"></i><span th:text="#{txt.logo.empresa}">Logo de la Empresa</span>
                                    </h6>
                                 </div>
                                 <div class="card-body">
                                    <div class="row">
                                       <div class="col-12 mb-3">
                                          <label for="logoEmpresa" class="form-label"><span th:text="#{txt.subir.logo.empresa}">Subir Logo</span></label>
                                          <input id="logoEmpresa" type="file" accept="image/*" name="logoEmpresa" class="form-control">
                                       </div>

                                       <div class="col-12" id="loadLogoEmpresa">
                                          <img th:if="${emisor.logoEmpresa != null and #strings.length(emisor.logoEmpresa)>0}"
                                               class="img-thumbnail"
                                               style="max-width: 300px;"
                                               th:src="@{'/logo/' + ${emisor.logoEmpresa}}"
                                               alt="Logo Empresa">
                                       </div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="row">
                           <div class="col-12">
                              <div class="d-flex gap-2 flex-wrap">
                                 <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i><span th:text="#{btn.guardar}">Guardar</span>
                                 </button>
                                 <a th:href="@{/emisor/}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i><span th:text="#{txt.btn-regresar}">Regresar</span>
                                 </a>
                                 <button th:if="${#authorization.expression('isAuthenticated()') and #strings.contains(#authentication.principal.authorities,'ROLE_ADMIN')}"
                                         type="button"
                                         id="updateFechaLlaveCriptografica"
                                         class="btn btn-warning btn-lg">
                                    <i class="fas fa-sync me-2"></i>Actualizar Fechas Llave Criptográfica
                                 </button>
                              </div>
                              <p class="text-muted mt-3">
                                 <i class="fas fa-asterisk text-danger me-1"></i>
                                 <small>Campos requeridos</small>
                              </p>
                           </div>
                        </div>

                     </form>
                  </div>

                  <!-- TAB: Actividades Económicas -->
                  <div class="tab-pane fade" id="actividades-economicas" role="tabpanel" th:if="${emisor.id != null}">
                     <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0">
                           <h6 class="mb-0 form-section-title">
                              <i class="fas fa-briefcase"></i>Actividades Económicas
                           </h6>
                        </div>
                        <div class="card-body">
                           <form id="formAddActividad" autocomplete="off" th:action="@{/emisor/actividades/save}" method="post">
                              <div class="row mb-4">
                                 <div class="col-md-10 mb-3">
                                    <label for="_codigoActividadEmisor" class="form-label"><span class="text-danger">*</span> Actividad Económica</label>
                                    <select class="form-select" id="_codigoActividadEmisor" name="codigoActividadEmisor" required>
                                       <option value="" selected th:text="#{txt.combo.seleccione}">Seleccione</option>
                                       <option th:each="k : ${listaActividades}" th:value="${k.codigoActividad}" th:text="${k.detalleActividad}"></option>
                                    </select>
                                    <input type="hidden" id="_detalleActividad" name="detalleActividad">
                                 </div>

                                 <div class="col-md-2 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-success w-100">
                                       <i class="fas fa-plus me-2"></i>Agregar
                                    </button>
                                 </div>
                              </div>
                           </form>

                           <div class="table-responsive">
                              <table class="table table-hover">
                                 <thead>
                                 <tr>
                                    <th style="width: 15%">Código</th>
                                    <th style="width: 85%">Detalle</th>
                                 </tr>
                                 </thead>
                                 <tbody id="loadActividades"></tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- TAB: Sucursales -->
                  <div class="tab-pane fade" id="sucursales" role="tabpanel" th:if="${emisor.id != null}">
                     <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                           <h6 class="mb-0 form-section-title">
                              <i class="fas fa-store"></i><span th:text="#{txt.sucursales}">Sucursales</span>
                           </h6>
                           <button class="btn btn-success btn-form-sucursal" data-id="0" data-bs-toggle="modal" data-bs-target=".modal-sucursal">
                              <i class="fas fa-plus me-2"></i><span th:text="#{btn.nuevo.registro}">Nueva Sucursal</span>
                           </button>
                        </div>
                        <div class="card-body">
                           <div class="table-responsive">
                              <table class="table table-hover">
                                 <thead>
                                 <tr>
                                    <th style="width: 10%">Número</th>
                                    <th style="width: 20%">Nombre</th>
                                    <th style="width: 20%">Encargado</th>
                                    <th style="width: 10%">Teléfono</th>
                                    <th style="width: 10%">Correo</th>
                                    <th style="width: 20%">Dirección</th>
                                    <th style="width: 10%">Acciones</th>
                                 </tr>
                                 </thead>
                                 <tbody id="loadSucursales"></tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- TAB: Terminales -->
                  <div class="tab-pane fade" id="terminales" role="tabpanel" th:if="${emisor.id != null}">
                     <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                           <h6 class="mb-0 form-section-title">
                              <i class="fas fa-desktop"></i><span th:text="#{txt.terminales}">Terminales</span>
                           </h6>
                           <button class="btn btn-success btn-form-terminal" data-id="0" data-bs-toggle="modal" data-bs-target=".modal-terminal">
                              <i class="fas fa-plus me-2"></i><span th:text="#{btn.nuevo.registro}">Nueva Terminal</span>
                           </button>
                        </div>
                        <div class="card-body">
                           <div class="table-responsive">
                              <table class="table table-hover table-sm">
                                 <thead>
                                 <tr>
                                    <th>Número</th>
                                    <th>Nombre</th>
                                    <th>FE</th>
                                    <th>ND</th>
                                    <th>NC</th>
                                    <th>TE</th>
                                    <th>CCE</th>
                                    <th>CPCE</th>
                                    <th>RCE</th>
                                    <th>FCE</th>
                                    <th>FEE</th>
                                    <th>Acciones</th>
                                 </tr>
                                 </thead>
                                 <tbody id="loadTerminales"></tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- TAB: API -->
                  <div class="tab-pane fade" id="api" role="tabpanel" th:if="${emisor.id != null}">
                     <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0">
                           <h6 class="mb-0 form-section-title">
                              <i class="fas fa-code"></i><span th:text="#{txt.api}">Credenciales API</span>
                           </h6>
                        </div>
                        <div class="card-body">
                           <div class="alert alert-info">
                              <h6 class="alert-heading">Credenciales de Acceso API</h6>
                              <hr>
                              <p class="mb-1"><strong>Usuario:</strong> <code th:text="${emisor.identificacion}"></code></p>
                              <p class="mb-0"><strong>Password:</strong> <code th:text="${emisor.tokenAccess}"></code></p>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- TAB: Acceso Usuarios -->
                  <div class="tab-pane fade" id="acceso-usuarios" role="tabpanel" th:if="${emisor.id != null}">
                     <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light border-0">
                           <h6 class="mb-0 form-section-title">
                              <i class="fas fa-users"></i><span th:text="#{txt.acceso.a.terminales}">Acceso a Terminales</span>
                           </h6>
                        </div>
                        <div class="card-body">
                           <div class="row mb-4">
                              <div class="col-md-5 mb-3">
                                 <label for="sucursalId" class="form-label"><span th:text="#{txt.seleccione.la.sucursal}">Seleccione la Sucursal</span></label>
                                 <select class="form-select" id="sucursalId">
                                    <option th:value="''" selected th:text="#{txt.combo.seleccione}">Seleccione</option>
                                    <option th:each="k : ${listaSucursales}" th:value="${k.id}" th:text="${k.nombreSucursal}"></option>
                                 </select>
                              </div>

                              <div class="col-md-3 mb-3">
                                 <label class="form-label">&nbsp;</label>
                                 <div class="d-flex gap-2">
                                    <button id="reloadPage" class="btn btn-secondary">
                                       <i class="fas fa-sync-alt me-2"></i>Refrescar
                                    </button>
                                    <button id="btnModalNuevoAcceso" data-bs-toggle="modal" data-bs-target=".modal-nuevo-acceso" class="btn btn-success">
                                       <i class="fas fa-plus-circle me-2"></i>Nuevo Acceso
                                    </button>
                                 </div>
                              </div>
                           </div>

                           <div class="table-responsive">
                              <table class="table table-hover table-sm">
                                 <thead>
                                 <tr>
                                    <th>Terminal</th>
                                    <th>Usuario</th>
                                    <th>Fecha</th>
                                    <th>Documento</th>
                                    <th>Actividad</th>
                                    <th>Modifica Precio</th>
                                    <th>Descuento</th>
                                    <th>Desc. Máx.</th>
                                    <th>Acciones</th>
                                 </tr>
                                 </thead>
                                 <tbody id="loadTerminalUsuario"></tbody>
                              </table>
                           </div>
                        </div>
                     </div>
                  </div>

               </div>
            </div>
         </div>

      </div>
   </main>
</div>

<!-- Modales -->
<div class="modal fade modal-sucursal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" th:if="${emisor.id != null}">
   <div class="modal-dialog modal-lg">
      <div class="modal-content" id="loadFormSucursal"></div>
   </div>
</div>

<div class="modal fade modal-terminal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" th:if="${emisor.id != null}">
   <div class="modal-dialog modal-lg">
      <div class="modal-content" id="loadFormTerminal"></div>
   </div>
</div>

<div class="modal fade modal-nuevo-acceso" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" th:if="${emisor.id != null}">
   <div class="modal-dialog modal-lg">
      <div class="modal-content" id="loadFormNuevoAcceso"></div>
   </div>
</div>

<input id="csrfToken" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
<link th:href="@{/css/pages/emisor-form.css}" rel="stylesheet">
<div th:replace="~{layout/layout :: scripts}"></div>

<script type="text/javascript">

   function loadingShow() {
      if (!document.getElementById('loading-overlay')) {
         const overlay = document.createElement('div');
         overlay.id = 'loading-overlay';
         overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;justify-content:center;align-items:center';
         overlay.innerHTML = '<div style="background:white;padding:2rem;border-radius:0.5rem;text-align:center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p style="margin-top:1rem;color:#5a5c69">Cargando...</p></div>';
         document.body.appendChild(overlay);
      }
   }

   function loadingHide() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.remove();
   }

   $("#reloadPage").click(function() {
      location.reload();
   });

   var token = $('#csrfToken').val();

   function getActividades() {
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {
            loadingShow();
         },
         url: "[(@{/emisor/actividades})]",
         data: {
            _csrf: token
         },
         success: function(data) {
            $("#loadActividades").html(data);
         },
         complete: function() {
            loadingHide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   }

   $(document).on("change", "#_codigoActividadEmisor", function(e) {
      var v = $(this).find('option:selected').text();
      $("#_detalleActividad").val(v);
   });

   $(document).on("click", "#getActividades", function(e) {
      e.preventDefault();
      getActividades();
   });

   $(document).on("submit", "#formAddActividad", function(e) {
      e.preventDefault();
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {
            loadingShow();
         },
         url: "[(@{/emisor/actividades/save})]",
         data: $(this).serialize(),
         success: function(data) {

            if (parseInt(data.response) === 200) {
               swal("Éxito!", "Actividad creada con éxito", "success");
               getActividades();
            } else if (parseInt(data.response) === 201) {
               swal("Notificación!", "La actividad ya se encuentra registrada", "warning");
            }

         },
         complete: function() {
            loadingHide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   });




   $(document).on('change', '#tipoDeIdentificacion', function() {

      var v = $(this).val();

      $("#identificacion").val("");

      if (v != "") {
         $("#identificacion").removeAttr("disabled");
      } else {
         $("#identificacion").attr("disabled", true);
      }

      if (v == "1") {
         //fisico
         $("#identificacion").attr('maxlength', '9');
      } else if (v == "2") {
         //juricio
         $("#identificacion").attr('maxlength', '10');
      } else {
         $("#identificacion").attr('maxlength', '12');
         $("#identificacion").removeClass("iden_fisica");
         $("#identificacion").removeClass("iden_juridica");
      }

      if ($(this).val() != "") {
         $(".error").fadeOut();
         return false;
      }

   });

   $("#formEmpresa").submit(function(event) {

      //Valido las cédulas
      var v = $("#tipoDeIdentificacion").val();
      var i = $("#identificacion").val();
      if (v == "1") {

         //fisico
         if (i.length != 9) {

            swal({
               text: "¡La cédula física debe contener 9 dígitos, sin espacios y sin guiones!",
               button: {
                  text: "Aceptar",
               },
               icon: "warning",
               closeModal: false
            }).then(function() {
               swal.close();
               $("#identificacion").focus();
            });

            return false;
         }

      } else if (v == "2") {
         //juricio
         if (i.length != 10) {

            swal({
               text: "¡La cédula jurídica debe contener 10 dígitos, sin espacios y sin guiones!",
               button: {
                  text: "Aceptar",
               },
               icon: "warning",
               closeModal: false
            }).then(function() {
               swal.close();
               $("#identificacion").focus();
            });

            return false;
         }
      }

      //Valido los teléfonos
      var tel1 = $("#telefono").val();
      if (tel1.length != 8) {

         swal({
            text: "¡El número de teléfono debe contener 8 dígitos, sin espacios y sin guiones!",
            button: {
               text: "Aceptar",
            },
            icon: "warning",
            closeModal: false
         }).then(function() {
            swal.close();
            $("#telefono").focus();
         });

         return false;
      }

      var formData = new FormData(
          $(this)[0]);
      $
      .ajax({
         type: "POST",
         cache: false,
         contentType: false,
         processData: false,
         beforeSend: function() {
            loadingShow();
         },
         url: "[(@{/emisor/save})]",
         data: formData,
         success: function(
             data) {
            //LoadRegistroValidaciones(data.id);

            if (parseInt(data.resp) === 1) {

               if (parseInt(data.resp_llave) === 2) {

                  swal(
                      "Notificación!",
                      "El pin de producción no corresponde a la llave criptográfica, verifique nuevamente, si no está seguro ingrese al ATV revoque la llave y vuelva a generarla.",
                      "warning", {
                         button: "Aceptar",
                      });
                  return false;

               }

               swal(
                   "Éxito!",
                   "La datos se guardaron con éxito.",
                   "success", {
                      button: "Aceptar",
                   });

               if (data.llave) {
                  $(
                      "#loadLlaveCriptografica")
                  .html(
                      '<a href="@{/llave/}' + data.llave + '"><i class="fa fa-cloud-download" aria-hidden="true"></i> Descargar llave criptográfica</a>');

               }

               if (data.logo) {
                  $(
                      "#loadLogoEmpresa")
                  .html(
                      '<img class="img-thumbnail logo-empresa" src="[(@{/logo/})]' +
                      data.logo +
                      '" />');
               }

               $(
                   "#logoEmpresa, #llaveCriptografica")
               .val(
                   "");

            } else if (parseInt(data.resp) === 2) {
               swal(
                   "Error!",
                   "Error al guardar los datos!",
                   "error", {
                      button: "Aceptar",
                   });
            } else if (parseInt(data.response) === 0) {
               location.href = "[(@{/})]"
            }

         },
         complete: function() {
            loadingHide();
         },
         error: function(x,
             t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });

      return false;
   });

   $(document).on("click", "#updateFechaLlaveCriptografica", function(e) {

      e.preventDefault();

      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/emisor/update-dates-criptografica})]",
         data: {
            _csrf: token
         },
         success: function(data) {

            console.log(data);

            if (parseInt(data.resp) === 1) {
               swal("", data.msj, "success");
            } else {
               swal("", data.msj, "warning");
            }

         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });

   });

   $(document).on("change", "#provincia", function(e) {

      e.preventDefault();

      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/ubicacion/cantones})]",
         data: {
            id: $(this).val(),
            _csrf: token
         },
         success: function(data) {
            $("#canton").html(data);
            $('#canton').select2('open');
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });

   });

   $(document).on("change", "#canton", function(e) {

      e.preventDefault();

      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/ubicacion/distritos})]",
         data: {
            id: $(this).val(),
            _csrf: token
         },
         success: function(data) {
            $("#distrito").html(data);
            $('#distrito').select2('open');
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });

   });

   $(document).on("change", "#distrito", function(e) {
      e.preventDefault();
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/ubicacion/barrios})]",
         data: {
            id: $(this).val(),
            _csrf: token
         },
         success: function(data) {
            $("#barrio").html(data);
            $('#barrio').select2('open');
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   });

   function loadSucursales() {
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/sucursales/})]",
         data: {
            _csrf: token
         },
         success: function(data) {
            $("#loadSucursales").html(data);
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   }

   $(document).on("click", "#getSucursales",
       function(e) {
          loadSucursales();
       });

   $(document)
   .on(
       "click",
       ".btn-form-sucursal",
       function(e) {
          e.preventDefault();

          $
          .ajax({
             type: "POST",
             cache: false,
             beforeSend: function() {},
             url: "[(@{/sucursales/form/edit})]",
             data: {
                id: $(this)
                .attr(
                    "data-id"),
                _csrf: token
             },
             success: function(
                 data) {
                $(
                    "#loadFormSucursal")
                .html(
                    data);
             },
             complete: function() {
                //loading_hide();
             },
             error: function(x,
                 t, m) {
                if (t === "timeout") {

                } else {

                }
             }
          });
       });

   $(document)
   .on(
       "submit",
       "#formSucursal",
       function() {

          $
          .ajax({
             type: "POST",
             cache: false,
             beforeSend: function() {},
             url: "[(@{/sucursales/form/save})]",
             data: $(
                 "#formSucursal")
             .serialize(),
             success: function(
                 data) {

                if (parseInt(data.response) === 1) {
                   swal(
                       "Éxito!",
                       "La datos se guardaron con éxito.",
                       "success", {
                          button: "Aceptar",
                       });
                   loadSucursales();
                } else if (parseInt(data.response) === 2) {
                   swal(
                       "Error!",
                       "El número de sucursal ya existe, debe cambiarlo!",
                       "error", {
                          button: "Aceptar",
                       });
                } else if (parseInt(data.response) === 0) {
                   location.href = "[(@{/})]"
                }

             },
             complete: function() {
                //loading_hide();
             },
             error: function(x,
                 t, m) {
                if (t === "timeout") {

                } else {

                }
             }
          });

          return false;
       });

   function loadTerminales() {
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/terminales/})]",
         data: {
            _csrf: token
         },
         success: function(data) {
            $("#loadTerminales").html(data);
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   }

   $(document).on("click", "#getTerminales",
       function(e) {
          loadTerminales();
       });

   $(document)
   .on(
       "click",
       ".btn-form-terminal",
       function(e) {
          e.preventDefault();

          $
          .ajax({
             type: "POST",
             cache: false,
             beforeSend: function() {},
             url: "[(@{/terminales/form/edit})]",
             data: {
                id: $(this)
                .attr(
                    "data-id"),
                _csrf: token
             },
             success: function(
                 data) {
                $(
                    "#loadFormTerminal")
                .html(
                    data);
             },
             complete: function() {
                //loading_hide();
             },
             error: function(x,
                 t, m) {
                if (t === "timeout") {

                } else {

                }
             }
          });
       });

   $(document)
   .on(
       "submit",
       "#formTerminal",
       function() {

          $
          .ajax({
             type: "POST",
             cache: false,
             beforeSend: function() {},
             url: "[(@{/terminales/form/save})]",
             data: $(
                 "#formTerminal")
             .serialize(),
             success: function(
                 data) {

                if (parseInt(data.response) === 1) {
                   swal(
                       "Éxito!",
                       "La datos se guardaron con éxito.",
                       "success", {
                          button: "Aceptar",
                       });
                   loadTerminales();
                } else if (parseInt(data.response) === 2) {
                   swal(
                       "Error!",
                       "El número de terminal ya existe, debe cambiarlo!",
                       "error", {
                          button: "Aceptar",
                       });
                } else if (parseInt(data.response) === 0) {
                   location.href = "[(@{/})]"
                }

             },
             complete: function() {
                //loading_hide();
             },
             error: function(x,
                 t, m) {
                if (t === "timeout") {

                } else {

                }
             }
          });

          return false;
       });

   function loadAccesoATerminales(id, token) {
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/terminales/acceso/})]",
         data: {
            id: id,
            _csrf: token
         },
         success: function(data) {
            $("#loadTerminalUsuario").html(data);
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   }

   $(document).on("change", "#sucursalId", function(e) {
      e.preventDefault();
      loadAccesoATerminales($(this).val(), token);
   });

   $(document).on("click", "#btnModalNuevoAcceso", function(e) {

      e.preventDefault();

      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/terminales/acceso/form-nuevo-acceso})]",
         data: {
            id: $(this).val(),
            _csrf: token
         },
         success: function(data) {
            $("#loadFormNuevoAcceso").html(data);
         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });

   });

   $(document).on("change", "#ComboSucursalId", function() {
      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/terminales/acceso/terminales-por-sucursal})]",
         data: {
            id: $(this).val(),
            _csrf: token
         },
         success: function(data) {
            $("#terminalBySucursal").html(data)

            $('#terminalBySucursal').select2('open');

         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   });

   $(document).on("submit", "#formTerminalNuevoAcceso", function(e) {

      e.preventDefault();

      $.ajax({
         type: "POST",
         cache: false,
         beforeSend: function() {},
         url: "[(@{/terminales/acceso/form-save-nuevo-acceso})]",
         data: $(this).serialize(),
         success: function(data) {


            if (parseInt(data.resp) === 1) {
               loadAccesoATerminales(data.sucursal, token);
            } else {
               swal("", "Este usuario ya tiene asignado la terminal.", "warning");
            }


         },
         complete: function() {
            //loading_hide();
         },
         error: function(x, t, m) {
            if (t === "timeout") {

            } else {

            }
         }
      });
   });

   $(document).on("click", ".btn-delete-acceso-terminal", function(e) {

      e.preventDefault();

      swal({
         title: "Confirme para eliminar",
         text: "Una vez eliminado no se podrá recuperar!",
         icon: "warning",
         buttons: true,
         dangerMode: true,
      })
      .then((willDelete) => {
         if (willDelete) {

            $.ajax({
               type: "POST",
               cache: false,
               beforeSend: function() {},
               url: "[(@{/terminales/acceso/delete-acceso-usuario})]",
               data: {
                  id: $(this).attr("data-id"),
                  s: $(this).attr("data-s"),
                  _csrf: token
               },
               success: function(data) {

                  loadAccesoATerminales(data.sucursal, token);

               },
               complete: function() {
                  //loading_hide();
               },
               error: function(x, t, m) {
                  if (t === "timeout") {

                  } else {

                  }
               }
            });

            swal("Eliminado con éxito!", {
               icon: "success",
            });
         }
      });

   });
</script>
</body>
</html>