<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="es">
<head th:replace="~{layout/layout :: head}">
   <title>Nueva Empresa - SAMYX</title>
</head>
<body>
<div id="main-wrapper">
   <!-- Header -->
   <header th:replace="~{layout/layout :: header}"></header>

   <!-- Page Content -->
   <main class="py-5">
      <div class="container-fluid">

         <!-- Page Header -->
         <div class="row mb-5">
            <div class="col-md-8">
               <h1 class="h2 mb-1">
                  <i class="fas fa-plus-circle me-2"></i>Nueva Empresa
               </h1>
               <p class="text-muted mb-0">Registra una nueva empresa en el sistema</p>
            </div>
            <div class="col-md-4 text-md-end">
               <a class="btn btn-outline-secondary btn-lg"
                  th:href="@{/emisor/}">
                  <i class="fas fa-arrow-left me-2"></i>Volver
               </a>
            </div>
         </div>

         <!-- Form Card -->
         <form id="formEmpresa" th:action="@{/emisor/guardar-empresa}" method="post" th:object="${emisor}" novalidate class="row">

            <!-- Sección: Datos del Emisor -->
            <div class="col-12 mb-4">
               <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light border-0 pb-0">
                     <div class="d-flex align-items-center">
                        <div class="empresa-icon bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                           <i class="fas fa-building text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                           <h5 class="mb-0">Datos del Emisor</h5>
                           <small class="text-muted">Información básica de la empresa</small>
                        </div>
                     </div>
                  </div>
                  <div class="card-body">

                     <div class="row">
                        <div class="col-md-3 mb-3">
                           <label for="codigoActividad" class="form-label">Código Actividad <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control num-integer"
                                  id="codigoActividad"
                                  th:field="*{codigoActividad}"
                                  placeholder="6 dígitos"
                                  maxlength="6"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('codigoActividad')}" th:errors="*{codigoActividad}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="tipoDeIdentificacion" class="form-label">Tipo de Identificación <span class="text-danger">*</span></label>
                           <select class="form-select" id="tipoDeIdentificacion" th:field="*{tipoDeIdentificacion}" required>
                              <option value="">-- Selecciona --</option>
                              <option value="1">Cédula Física</option>
                              <option value="2">Cédula Jurídica</option>
                              <option value="3">DIMEX</option>
                              <option value="4">NITE</option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('tipoDeIdentificacion')}" th:errors="*{tipoDeIdentificacion}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="identificacion" class="form-label">Identificación <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control num-integer"
                                  id="identificacion"
                                  th:field="*{identificacion}"
                                  placeholder="Sin guiones"
                                  disabled
                                  required>
                           <small class="text-muted d-block" id="id-hint" style="font-size: 0.75rem;">
                              <i class="fas fa-info-circle"></i> Física: 9 dígitos
                           </small>
                           <small class="text-danger" th:if="${#fields.hasErrors('identificacion')}" th:errors="*{identificacion}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="nombreRazonSocial" class="form-label">Nombre o Razón Social <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control"
                                  id="nombreRazonSocial"
                                  th:field="*{nombreRazonSocial}"
                                  placeholder="Nombre empresa"
                                  maxlength="100"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('nombreRazonSocial')}" th:errors="*{nombreRazonSocial}"></small>
                        </div>
                     </div>

                     <div class="row">
                        <div class="col-md-4 mb-3">
                           <label for="nombreComercial" class="form-label">Nombre Comercial <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control"
                                  id="nombreComercial"
                                  th:field="*{nombreComercial}"
                                  maxlength="80"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('nombreComercial')}" th:errors="*{nombreComercial}"></small>
                        </div>
                        <div class="col-md-4 mb-3">
                           <label for="email" class="form-label">Correo <span class="text-danger">*</span></label>
                           <input type="email"
                                  class="form-control"
                                  id="email"
                                  th:field="*{email}"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></small>
                        </div>
                        <div class="col-md-2 mb-3">
                           <label for="codigoPais" class="form-label">Código País</label>
                           <input type="text"
                                  class="form-control num-integer"
                                  id="codigoPais"
                                  value="506"
                                  maxlength="3"
                                  readonly>
                        </div>
                        <div class="col-md-2 mb-3">
                           <label for="telefono" class="form-label">Teléfono <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control num-integer"
                                  id="telefono"
                                  th:field="*{telefono}"
                                  placeholder="8 dígitos"
                                  maxlength="8"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}"></small>
                        </div>
                     </div>

                     <div class="row">
                        <div class="col-md-3 mb-3">
                           <label for="fax" class="form-label">Fax</label>
                           <input type="text"
                                  class="form-control num-integer"
                                  id="fax"
                                  th:field="*{fax}"
                                  maxlength="8">
                           <small class="text-danger" th:if="${#fields.hasErrors('fax')}" th:errors="*{fax}"></small>
                        </div>
                        <div class="col-md-9 mb-3">
                           <label for="otrasSenas" class="form-label">Otras Señas <span class="text-danger">*</span></label>
                           <input type="text"
                                  class="form-control"
                                  id="otrasSenas"
                                  th:field="*{otrasSenas}"
                                  required>
                           <small class="text-danger" th:if="${#fields.hasErrors('otrasSenas')}" th:errors="*{otrasSenas}"></small>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Sección: Ubicación -->
            <div class="col-12 mb-4">
               <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light border-0 pb-0">
                     <h6 class="mb-0 form-section-title">
                        <i class="fas fa-map-marker-alt"></i>Ubicación de la Empresa
                     </h6>
                  </div>
                  <div class="card-body">
                     <div class="row">
                        <div class="col-md-3 mb-3">
                           <label for="provincia" class="form-label">Provincia <span class="text-danger">*</span></label>
                           <select class="form-select" id="provincia" th:field="*{provincia}" required>
                              <option value="">-- Selecciona --</option>
                              <option th:each="k : ${listaProvincias}" th:value="${k.id}" th:text="${k.provincia}"></option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('provincia')}" th:errors="*{provincia}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="canton" class="form-label">Cantón <span class="text-danger">*</span></label>
                           <select class="form-select" id="canton" th:field="*{canton}" required>
                              <option th:each="k : ${listaCantones}" th:value="${k.id}" th:text="${k.canton}"></option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('canton')}" th:errors="*{canton}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="distrito" class="form-label">Distrito <span class="text-danger">*</span></label>
                           <select class="form-select" id="distrito" th:field="*{distrito}" required>
                              <option th:each="k : ${listaDistritos}" th:value="${k.id}" th:text="${k.distrito}"></option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('distrito')}" th:errors="*{distrito}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="barrio" class="form-label">Barrio</label>
                           <select class="form-select" id="barrio" th:field="*{barrio}">
                              <option value="">-- Opcional --</option>
                              <option th:each="k : ${listaBarrios}" th:value="${k.id}" th:text="${k.barrio}"></option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('barrio')}" th:errors="*{barrio}"></small>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Sección: Parámetros de la Empresa -->
            <div class="col-12 mb-4">
               <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light border-0 pb-0">
                     <h6 class="mb-0 form-section-title">
                        <i class="fas fa-cogs"></i>Parámetros de la Empresa
                     </h6>
                  </div>
                  <div class="card-body">

                     <div class="row">
                        <div class="col-md-12 mb-3">
                           <label for="detalleEnFactura1" class="form-label">Detalle en Factura 1</label>
                           <textarea rows="2" class="form-control" id="detalleEnFactura1" th:field="*{detalleEnFactura1}"></textarea>
                           <small class="text-danger" th:if="${#fields.hasErrors('detalleEnFactura1')}" th:errors="*{detalleEnFactura1}"></small>
                        </div>
                        <div class="col-md-12 mb-3">
                           <label for="detalleEnFactura2" class="form-label">Detalle en Factura 2</label>
                           <textarea rows="2" class="form-control" id="detalleEnFactura2" th:field="*{detalleEnFactura2}"></textarea>
                           <small class="text-danger" th:if="${#fields.hasErrors('detalleEnFactura2')}" th:errors="*{detalleEnFactura2}"></small>
                        </div>
                        <div class="col-md-12 mb-3">
                           <label for="notaValidezProforma" class="form-label">Validez de la Proforma</label>
                           <textarea rows="2" class="form-control" id="notaValidezProforma" th:field="*{notaValidezProforma}"></textarea>
                           <small class="text-danger" th:if="${#fields.hasErrors('notaValidezProforma')}" th:errors="*{notaValidezProforma}"></small>
                        </div>
                     </div>

                     <div class="row">
                        <div class="col-md-3 mb-3">
                           <label for="ambiente" class="form-label">Ambiente Trabajo <span class="text-danger">*</span></label>
                           <select class="form-select" id="ambiente" th:field="*{ambiente}" required>
                              <option th:value="'prod'">Producción</option>
                              <option sec:authorize="hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN')" th:value="'stag'">Staging</option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('ambiente')}" th:errors="*{ambiente}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="statusEmpresa" class="form-label">Estado Empresa <span class="text-danger">*</span></label>
                           <select class="form-select" id="statusEmpresa" th:field="*{statusEmpresa}" required>
                              <option th:value="true">Activo</option>
                              <option th:value="false">Desactivado</option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('statusEmpresa')}" th:errors="*{statusEmpresa}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="emailNotificacion" class="form-label">Email Notificaciones <span class="text-danger">*</span></label>
                           <input type="email" class="form-control" id="emailNotificacion" th:field="*{emailNotificacion}" required>
                           <small class="text-danger" th:if="${#fields.hasErrors('emailNotificacion')}" th:errors="*{emailNotificacion}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="impresion" class="form-label">Impresión <span class="text-danger">*</span></label>
                           <select class="form-select" id="impresion" th:field="*{impresion}" required>
                              <option th:value="'1'">Carta</option>
                              <option th:value="'2'">Tiquete</option>
                           </select>
                           <small class="text-danger" th:if="${#fields.hasErrors('impresion')}" th:errors="*{impresion}"></small>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Sección: Usuario MH -->
            <div class="col-12 mb-4">
               <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light border-0 pb-0">
                     <h6 class="mb-0 form-section-title">
                        <i class="fas fa-lock"></i>Usuario, Contraseña y PIN Ministerio de Hacienda
                     </h6>
                  </div>
                  <div class="card-body">
                     <div class="row">
                        <div class="col-md-6 mb-3">
                           <label for="userApi" class="form-label">Usuario API <span class="text-danger">*</span></label>
                           <input type="text" class="form-control" id="userApi" th:field="*{userApi}" required>
                           <small class="text-danger" th:if="${#fields.hasErrors('userApi')}" th:errors="*{userApi}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="pwApi" class="form-label">Contraseña API <span class="text-danger">*</span></label>
                           <input type="text" class="form-control" id="pwApi" th:field="*{pwApi}" required>
                           <small class="text-danger" th:if="${#fields.hasErrors('pwApi')}" th:errors="*{pwApi}"></small>
                        </div>
                        <div class="col-md-3 mb-3">
                           <label for="pingApi" class="form-label">PIN <span class="text-danger">*</span></label>
                           <input type="text" class="form-control" id="pingApi" th:field="*{pingApi}" maxlength="4" required>
                           <small class="text-danger" th:if="${#fields.hasErrors('pingApi')}" th:errors="*{pingApi}"></small>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Mensajes -->
            <div class="col-12 mb-4">
               <div th:if="${response} == 2" class="alert alert-warning alert-dismissible fade show" role="alert">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Aviso:</strong> Existe otra empresa con la misma identificación o correo. Cambia estos datos.
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
               </div>
               <div th:if="${param.exito}" class="alert alert-success alert-dismissible fade show" role="alert">
                  <i class="fas fa-check-circle me-2"></i>
                  <strong>¡Éxito!</strong> La empresa ha sido registrada.
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
               </div>
            </div>

            <!-- Footer Buttons -->
            <div class="col-12">
               <div class="card-footer bg-light border-0 pt-0 px-0">
                  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                     <a class="btn btn-outline-secondary btn-lg"
                        th:href="@{/emisor/}">
                        <i class="fas fa-times me-2"></i>Cancelar
                     </a>
                     <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Guardar Empresa
                     </button>
                  </div>
               </div>
            </div>

         </form>

      </div>
   </main>

   <!-- Footer -->
   <footer th:replace="~{layout/layout :: footer}"></footer>
</div>

<!-- Scripts -->
<div th:replace="~{layout/layout :: scripts}"></div>

<!-- CSS específico de esta página -->
<link th:href="@{/css/pages/emisor-nueva-empresa.css}" rel="stylesheet" />

<input id="csrfToken" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

<script>
   var token = $('#csrfToken').val();

   $(document).on('change', '#tipoDeIdentificacion', function() {
      var v = $(this).val();
      $("#identificacion").val("");

      if (v != "") {
         $("#identificacion").removeAttr("disabled");
      } else {
         $("#identificacion").attr("disabled", true);
      }

      if (v == "1") {
         $("#identificacion").attr('maxlength', '9');
         $("#id-hint").html('<i class="fas fa-info-circle"></i> Cédula Física: 9 dígitos');
      } else if (v == "2") {
         $("#identificacion").attr('maxlength', '10');
         $("#id-hint").html('<i class="fas fa-info-circle"></i> Cédula Jurídica: 10 dígitos');
      } else if (v == "3") {
         $("#identificacion").attr('maxlength', '12');
         $("#id-hint").html('<i class="fas fa-info-circle"></i> DIMEX: hasta 12 dígitos');
      } else if (v == "4") {
         $("#identificacion").attr('maxlength', '10');
         $("#id-hint").html('<i class="fas fa-info-circle"></i> NITE: 10 dígitos');
      }
   });

   $("#formEmpresa").submit(function(event) {
      var v = parseInt($("#tipoDeIdentificacion").val());
      var i = $("#identificacion").val();

      if (v === 1) {
         if (i.length != 9) {
            swal({
               text: "¡La Cédula Física debe contener 9 dígitos, sin espacios y sin guiones!",
               button: { text: "Aceptar" },
               icon: "warning",
               closeModal: false
            }).then(function() {
               swal.close();
               $("#identificacion").focus();
            });
            return false;
         }
      } else if (v === 2) {
         if (i.length != 10) {
            swal({
               text: "¡La Cédula Jurídica debe contener 10 dígitos, sin espacios y sin guiones!",
               button: { text: "Aceptar" },
               icon: "warning",
               closeModal: false
            }).then(function() {
               swal.close();
               $("#identificacion").focus();
            });
            return false;
         }
      } else if (v === 4) {
         if (i.length != 10) {
            swal({
               text: "¡El NITE debe contener 10 dígitos, sin espacios y sin guiones!",
               button: { text: "Aceptar" },
               icon: "warning",
               closeModal: false
            }).then(function() {
               swal.close();
               $("#identificacion").focus();
            });
            return false;
         }
      }

      var tel1 = $("#telefono").val();
      if (tel1.length > 0 && tel1.length != 8) {
         swal({
            text: "¡El número de teléfono debe contener 8 dígitos, sin espacios y sin guiones!",
            button: { text: "Aceptar" },
            icon: "warning",
            closeModal: false
         }).then(function() {
            swal.close();
            $("#telefono").focus();
         });
         return false;
      }
   });

   $(document).on('change', '#provincia', function(e) {
      e.preventDefault();
      $.ajax({
         type: "POST",
         cache: false,
         url: "[(@{/ubicacion/cantones})]",
         data: { id: $(this).val(), _csrf: token },
         success: function(data) {
            $("#canton").html(data);
            $('#canton').select2('open');
         }
      });
   });

   $(document).on('change', '#canton', function(e) {
      e.preventDefault();
      $.ajax({
         type: "POST",
         cache: false,
         url: "[(@{/ubicacion/distritos})]",
         data: { id: $(this).val(), _csrf: token },
         success: function(data) {
            $("#distrito").html(data);
            $('#distrito').select2('open');
         }
      });
   });

   $(document).on('change', '#distrito', function(e) {
      e.preventDefault();
      $.ajax({
         type: "POST",
         cache: false,
         url: "[(@{/ubicacion/barrios})]",
         data: { id: $(this).val(), _csrf: token },
         success: function(data) {
            $("#barrio").html(data);
            $('#barrio').select2('open');
         }
      });
   });
</script>
</body>
</html>